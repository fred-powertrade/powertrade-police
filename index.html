<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PowerTrade Police v3 ‚Äî Live</title>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  POWERTRADE POLICE v3 ‚Äî PT-Centric Live Monitor         ‚ïë
  ‚ïë  GitHub Pages Ready                                      ‚ïë
  ‚ïë                                                          ‚ïë
  ‚ïë  SETUP:                                                  ‚ïë
  ‚ïë  1. Push this file as index.html to a GitHub repo        ‚ïë
  ‚ïë  2. Enable GitHub Pages (Settings ‚Üí Pages ‚Üí main)        ‚ïë
  ‚ïë  3. Open https://YOUR-USER.github.io/YOUR-REPO/          ‚ïë
  ‚ïë                                                          ‚ïë
  ‚ïë  APIs: All public, no auth required                      ‚ïë
  ‚ïë  ‚òÖ PowerTrade: api.rest.prod.power.trade                 ‚ïë
  ‚ïë    Deribit: www.deribit.com/api/v2/public                ‚ïë
  ‚ïë    OKX: www.okx.com/api/v5                               ‚ïë
  ‚ïë    Bybit: api.bybit.com/v5                               ‚ïë
  ‚ïë                                                          ‚ïë
  ‚ïë  CORS: If an exchange blocks browser requests from       ‚ïë
  ‚ïë  GitHub Pages, the dashboard auto-retries via a CORS     ‚ïë
  ‚ïë  proxy. Toggle proxy in Config tab.                      ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<style>
:root{
--bg:#06090e;--bg2:#0a0f17;--card:#0d1219;--bdr:#1a2233;
--tx:#c9d1d9;--dim:#5a6577;--mut:#3a4454;--wh:#f0f2f5;
--acc:#e6a817;--red:#ef4444;--redBg:rgba(239,68,68,.08);--redBd:rgba(239,68,68,.25);
--org:#f59e0b;--orgBg:rgba(245,158,11,.08);
--grn:#22c55e;--grnBg:rgba(34,197,94,.08);--grnBd:rgba(34,197,94,.25);
--blu:#3b82f6;--bluBg:rgba(59,130,246,.08);
--cyn:#06b6d4;--prp:#a78bfa;--prpBg:rgba(167,139,250,.08);
--fm:'SF Mono','Cascadia Code','Fira Code','Consolas',monospace;
--fs:'SF Pro Display','Inter','Segoe UI',system-ui,sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:var(--fs);font-size:12px;overflow-x:hidden}
::-webkit-scrollbar{width:4px;height:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:2px}
select,input,button{outline:none;font-family:var(--fm);font-size:10px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
@keyframes glow{0%,100%{box-shadow:0 0 8px rgba(230,168,23,.15)}50%{box-shadow:0 0 16px rgba(230,168,23,.3)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{display:inline-block;width:10px;height:10px;border:2px solid var(--bdr);border-top-color:var(--acc);border-radius:50%;animation:spin .6s linear infinite}
.hdr{background:var(--card);border-bottom:1px solid var(--bdr);padding:8px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:100}
.logo{display:flex;align-items:center;gap:8px}
.logo-i{width:32px;height:32px;border-radius:6px;background:linear-gradient(135deg,var(--acc),var(--red));display:flex;align-items:center;justify-content:center;font-size:16px;animation:glow 3s infinite}
.logo-t{font-family:var(--fm);font-size:13px;font-weight:800;letter-spacing:.1em;color:var(--acc);line-height:1.1}
.logo-s{font-family:var(--fm);font-size:7px;color:var(--dim);letter-spacing:.04em}
.hdr-r{display:flex;gap:4px;align-items:center;margin-left:auto;flex-wrap:wrap}
.btn{background:none;border:1px solid var(--bdr);border-radius:3px;color:var(--dim);padding:2px 8px;cursor:pointer;font-size:9px;transition:all .15s}
.btn:hover{border-color:var(--acc);color:var(--acc)}
.btn-a{background:rgba(230,168,23,.08);border-color:rgba(230,168,23,.25);color:var(--acc)}
.dot{width:6px;height:6px;border-radius:50%;display:inline-block}
.conn-bar{display:flex;gap:8px;padding:5px 16px;border-bottom:1px solid rgba(26,34,51,.5);font-family:var(--fm);font-size:8px;align-items:center;flex-wrap:wrap;background:var(--bg2)}
.conn{display:flex;align-items:center;gap:3px;padding:2px 6px;border-radius:3px;border:1px solid var(--bdr)}
.conn.ok{border-color:var(--grnBd);background:var(--grnBg)}
.conn.err{border-color:var(--redBd);background:var(--redBg)}
.conn.load{border-color:rgba(230,168,23,.2)}
.conn.proxy{border-color:rgba(167,139,250,.3);background:rgba(167,139,250,.05)}
.spot-bar{display:flex;gap:12px;padding:6px 16px;font-family:var(--fm);font-size:10px;border-bottom:1px solid var(--bdr);overflow-x:auto;background:var(--bg)}
.spot-item b{font-weight:800}
.kpi-bar{display:flex;gap:6px;padding:8px 16px;overflow-x:auto;background:var(--bg)}
.kpi{background:var(--card);border:1px solid var(--bdr);border-radius:5px;padding:8px 12px;min-width:88px;flex-shrink:0}
.kpi-l{font-family:var(--fm);font-size:7px;color:var(--dim);text-transform:uppercase;letter-spacing:.1em}
.kpi-v{font-family:var(--fm);font-size:18px;font-weight:800;line-height:1.2}
.kpi-s{font-family:var(--fm);font-size:8px;color:var(--mut)}
.tabs{display:flex;gap:0;padding:0 16px;border-bottom:1px solid var(--bdr);overflow-x:auto;background:var(--bg);position:sticky;top:49px;z-index:99}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--dim);font-family:var(--fm);font-size:9px;font-weight:700;padding:7px 10px;letter-spacing:.03em;white-space:nowrap;cursor:pointer;transition:all .12s}
.tab:hover{color:var(--tx)}.tab.on{color:var(--acc);border-bottom-color:var(--acc)}
.tab .cnt{margin-left:3px;background:var(--bdr);padding:0 4px;border-radius:6px;font-size:8px}
.tab.on .cnt{background:rgba(230,168,23,.15)}
.main{padding:10px 16px 20px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:6px;padding:10px;margin-bottom:8px;animation:fadeUp .2s ease}
.card-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:4px}
.card-t{font-family:var(--fm);font-size:10px;font-weight:700}
.badge{display:inline-flex;padding:1px 5px;border-radius:2px;font-family:var(--fm);font-size:8px;font-weight:700;letter-spacing:.04em}
.bg-red{color:var(--red);background:var(--redBg);border:1px solid var(--redBd)}
.bg-org{color:var(--org);background:var(--orgBg)}
.bg-grn{color:var(--grn);background:var(--grnBg);border:1px solid var(--grnBd)}
.bg-blu{color:var(--blu);background:var(--bluBg)}
.bg-prp{color:var(--prp);background:var(--prpBg)}
.bg-acc{color:var(--acc);background:rgba(230,168,23,.1)}
.tbl{width:100%;border-collapse:collapse;font-family:var(--fm);font-size:9px}
.tbl th{padding:4px 6px;text-align:right;color:var(--dim);font-size:7px;font-weight:600;text-transform:uppercase;border-bottom:1px solid var(--bdr);position:sticky;top:0;background:var(--card);z-index:1}
.tbl td{padding:3px 6px;text-align:right;border-bottom:1px solid rgba(26,34,51,.3)}
.tbl th:first-child,.tbl td:first-child{text-align:left}
.tbl-w{background:var(--card);border:1px solid var(--bdr);border-radius:5px;overflow:auto;max-height:600px}
.tbl tr:hover{background:rgba(230,168,23,.03)}
.filters{display:flex;gap:5px;margin-bottom:8px;flex-wrap:wrap;align-items:center}
.flt{background:var(--card);border:1px solid var(--bdr);border-radius:3px;color:var(--tx);padding:2px 5px;font-size:9px}
.alert-row{background:var(--card);border:1px solid var(--bdr);border-radius:4px;padding:6px 10px;margin-bottom:3px;cursor:pointer;border-left:3px solid var(--org);animation:fadeUp .15s ease}
.alert-row.crit{border-left-color:var(--red);border-color:var(--redBd)}
.alert-hd{display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.alert-t{font-size:10px;font-weight:600;flex:1}
.alert-d{margin-top:5px;padding-top:5px;border-top:1px solid var(--bdr);display:none;font-family:var(--fm);font-size:9px;color:var(--dim);line-height:1.5}
.alert-row.open .alert-d{display:block}
.grid{display:grid;gap:8px}
.g2{grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
.g3{grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
.g4{grid-template-columns:repeat(auto-fill,minmax(130px,1fr))}
.neg{color:var(--red)}.pos{color:var(--grn)}.dim{color:var(--dim)}.mono{font-family:var(--fm)}
.risk-hi{color:var(--red)!important;font-weight:700!important}
.risk-md{color:var(--org)!important;font-weight:600!important}
.bar-w{background:var(--bdr);border-radius:3px;overflow:hidden}
.bar{height:6px;border-radius:3px}
.th-row{display:flex;align-items:center;gap:5px;margin-bottom:5px}
.th-l{font-family:var(--fm);font-size:9px;color:var(--dim);width:160px}
.th-i{width:65px;padding:3px 6px;background:var(--bg);border:1px solid var(--bdr);border-radius:3px;color:var(--acc);text-align:right;font-size:11px}
.th-u{font-family:var(--fm);font-size:8px;color:var(--mut)}
.preset{display:block;width:100%;background:var(--bg);border:1px solid var(--bdr);border-radius:3px;color:var(--tx);padding:6px 10px;text-align:left;margin-bottom:3px;cursor:pointer;font-size:10px}
.preset:hover{border-color:var(--acc);color:var(--acc)}
.warn-box{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:4px;padding:8px 10px;margin-bottom:8px;font-family:var(--fm);font-size:9px;color:var(--org);line-height:1.4}
.info-box{background:rgba(59,130,246,.06);border:1px solid rgba(59,130,246,.2);border-radius:4px;padding:8px 10px;margin-bottom:8px;font-family:var(--fm);font-size:9px;color:var(--blu);line-height:1.4}
.prp-box{background:rgba(167,139,250,.06);border:1px solid rgba(167,139,250,.2);border-radius:4px;padding:8px 10px;margin-bottom:8px;font-family:var(--fm);font-size:9px;color:var(--prp);line-height:1.4}
.score-ring{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--fm);font-size:17px;font-weight:800;border:3px solid}
.footer{padding:8px 16px;border-top:1px solid var(--bdr);font-family:var(--fm);font-size:7px;color:var(--mut);display:flex;justify-content:space-between;flex-wrap:wrap;background:var(--bg2)}
.empty{padding:24px;text-align:center;color:var(--dim);font-family:var(--fm)}
</style>
</head>
<body>
<div id="app"><div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:var(--fm);color:var(--acc)"><div class="spinner" style="width:24px;height:24px;margin-right:12px"></div>Connecting to PowerTrade + exchanges‚Ä¶</div></div>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORS-AWARE FETCH ‚Äî tries direct, falls back to proxy
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Remembers which hosts need proxy so subsequent calls skip the failed direct attempt
const needsProxy = {};
const PROXY = 'https://corsproxy.io/?url=';

async function cFetch(url) {
  const host = new URL(url).host;
  const t0 = performance.now();
  // If we already know this host needs proxy, go straight there
  if (needsProxy[host] && G.useProxy) {
    return proxyFetch(url, t0);
  }
  try {
    const r = await fetch(url);
    const lat = Math.round(performance.now() - t0);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return { ok: true, data: await r.json(), lat, proxied: false };
  } catch (e) {
    // CORS or network error ‚Äî try proxy if enabled
    if (G.useProxy) {
      needsProxy[host] = true;
      return proxyFetch(url, t0);
    }
    return { ok: false, err: `${e.message} (CORS? Enable proxy in Config)`, lat: Math.round(performance.now() - t0), proxied: false };
  }
}

async function proxyFetch(url, t0) {
  try {
    const r = await fetch(PROXY + encodeURIComponent(url));
    const lat = Math.round(performance.now() - t0);
    if (!r.ok) throw new Error(`Proxy HTTP ${r.status}`);
    return { ok: true, data: await r.json(), lat, proxied: true };
  } catch (e) {
    return { ok: false, err: `Proxy failed: ${e.message}`, lat: Math.round(performance.now() - t0), proxied: true };
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IV SOLVER ‚Äî only for cross-exchange vol comparison
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const phi=x=>{const a=.254829592,b=-.284496736,c=1.421413741,d=-1.453152027,e=1.061405429,p=.3275911,s=x<0?-1:1,ax=Math.abs(x)/Math.SQRT2,t=1/(1+p*ax),y=1-(((((e*t+d)*t+c)*t+b)*t+a)*t)*Math.exp(-ax*ax);return .5*(1+s*y)};
const bsP=(S,K,T,r,v,cp)=>{if(T<=1e-6||v<=1e-6)return Math.max(0,cp==='C'?S-K:K-S);const sq=Math.sqrt(T),d1=(Math.log(S/K)+(r+v*v/2)*T)/(v*sq),d2=d1-v*sq;return cp==='C'?S*phi(d1)-K*Math.exp(-r*T)*phi(d2):K*Math.exp(-r*T)*phi(-d2)-S*phi(-d1)};
const solveIV=(price,S,K,T,r,cp)=>{if(T<=1e-6||price<=0)return null;let v=.5;for(let i=0;i<50;i++){const p=bsP(S,K,T,r,v,cp),d1=(Math.log(S/K)+(r+v*v/2)*T)/(v*Math.sqrt(T)),vg=S*Math.sqrt(T)*Math.exp(-d1*d1/2)/2.5066282746;if(vg<1e-10)break;v-=(p-price)/vg;if(v<=.001)v=.001;if(v>10)v=10;if(Math.abs(p-price)<1e-8)break}return(v>.001&&v<10)?v:null};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POWERTRADE: /v1/market_data/tradeable_entity/all/summary
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchPT(){
  const r = await cFetch('https://api.rest.prod.power.trade/v1/market_data/tradeable_entity/all/summary');
  if(!r.ok) return { opts:[], perps:[], spots:{}, ok:false, lat:r.lat, err:r.err, proxied:r.proxied };
  const opts=[], perps=[], spots={};
  for(const t of r.data){
    const bid=t.best_bid?parseFloat(t.best_bid):null;
    const ask=t.best_ask?parseFloat(t.best_ask):null;
    const last=t.last_price?parseFloat(t.last_price):null;
    const idx=t.index_price?parseFloat(t.index_price):null;
    const vol=t.volume?parseFloat(t.volume):0;
    const oi=t.open_interest?parseFloat(t.open_interest):0;
    if(t.product_type==='option'){
      const p=parsePTOpt(t.symbol);if(!p)continue;
      const S=idx||0; const mid=bid!=null&&ask!=null?(bid+ask)/2:(bid||ask||last||0);
      const sprd=bid!=null&&ask!=null&&mid>0?((ask-bid)/mid)*100:null;
      opts.push({ex:'PT',asset:p.asset,strike:p.strike,expiry:p.expiry,expiryDate:p.expiryDate,cp:p.cp,
        T:dTE(p.expiryDate)/365,bid,ask,mid,last,spot:S,sprd,vol24h:vol,oi,raw:t.symbol,id:t.id});
      if(S>0)spots[p.asset]=S;
    } else if(t.product_type==='perpetual_future'){
      const asset=t.symbol.split('-')[0]; const mark=last||((bid||0)+(ask||0))/2;
      perps.push({ex:'PT',asset,isPerpetual:true,instrument:t.symbol,mark,bid,ask,last,vol24h:vol,oi,spot:idx||0,
        funding:null,basis:idx>0?(mark-idx)/idx*100:0,id:t.id});
      if(idx>0)spots[asset]=idx;
    } else if(t.product_type==='index'){
      const asset=t.symbol.split('-')[0]; if(idx>0)spots[asset]=idx;
    }
  }
  return { opts, perps, spots, ok:true, lat:r.lat, count:r.data.length, proxied:r.proxied };
}

function parsePTOpt(sym){
  const m=sym.match(/^(\w+)-(\d{8})-(\d+)(C|P)$/); if(!m)return null;
  const[,a,ds,k,cp]=m; const y=parseInt(ds.slice(0,4)),mo=parseInt(ds.slice(4,6))-1,d=parseInt(ds.slice(6,8));
  const MN=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  return{asset:a,strike:parseInt(k),cp,expiry:`${d}${MN[mo]}${String(y).slice(2)}`,expiryDate:new Date(y,mo,d,8,0,0)};
}
function dTE(d){ return Math.max(0,(d.getTime()-Date.now())/864e5) }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DERIBIT / OKX / BYBIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MO={JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11};
function parseDI(n){const m=n.match(/^(\w+)-(\d{1,2})([A-Z]{3})(\d{2})-(\d+)-(C|P)$/);if(!m)return null;
  const[,a,day,mon,yr,k,cp]=m,y=2000+parseInt(yr),mo=MO[mon];if(mo===undefined)return null;
  return{asset:a,strike:parseInt(k),cp,expiry:`${day}${mon}${yr}`,expiryDate:new Date(y,mo,parseInt(day),8,0,0)}}
function parseOI(n){const m=n.match(/^(\w+)-USD-(\d{6})-(\d+)-(C|P)$/);if(!m)return null;
  const[,a,ds,k,cp]=m,y=2000+parseInt(ds.slice(0,2)),mo=parseInt(ds.slice(2,4))-1,d=parseInt(ds.slice(4,6));
  const mn=Object.keys(MO).find(k=>MO[k]===mo)||'???';
  return{asset:a,strike:parseInt(k),cp,expiry:`${d}${mn}${ds.slice(0,2)}`,expiryDate:new Date(y,mo,d,8,0,0)}}

async function fetchDeribit(asset){
  const[oR,fR]=await Promise.all([
    cFetch(`https://www.deribit.com/api/v2/public/get_book_summary_by_currency?currency=${asset}&kind=option`),
    cFetch(`https://www.deribit.com/api/v2/public/get_book_summary_by_currency?currency=${asset}&kind=future`)]);
  const opts=[],perps=[];let proxied=oR.proxied||fR.proxied;
  if(oR.ok&&oR.data?.result){for(const o of oR.data.result){const p=parseDI(o.instrument_name);if(!p)continue;
    const S=o.underlying_price||0;if(!S)continue;const bid=(o.bid_price||0)*S,ask=(o.ask_price||0)*S,mark=(o.mark_price||0)*S;
    const mid=bid>0&&ask>0?(bid+ask)/2:mark;const sprd=mid>0&&bid>0&&ask>0?((ask-bid)/mid)*100:null;
    opts.push({ex:'Deribit',asset:p.asset,strike:p.strike,expiry:p.expiry,expiryDate:p.expiryDate,cp:p.cp,
      T:dTE(p.expiryDate)/365,bid,ask,mid,spot:S,markIv:o.mark_iv?o.mark_iv/100:null,sprd,vol24h:o.volume||0,oi:o.open_interest||0,raw:o.instrument_name})}}
  if(fR.ok&&fR.data?.result){for(const f of fR.data.result){const S=f.underlying_price||0;if(!S)continue;
    perps.push({ex:'Deribit',asset,isPerpetual:f.instrument_name.includes('PERPETUAL'),instrument:f.instrument_name,
      mark:f.mark_price||0,bid:f.bid_price||0,ask:f.ask_price||0,vol24h:f.volume||0,oi:f.open_interest||0,
      spot:S,funding:f.current_funding!=null?f.current_funding:null,basis:S>0?((f.mark_price||S)-S)/S*100:0})}}
  return{opts,perps,oOk:oR.ok,fOk:fR.ok,lat:Math.max(oR.lat,fR.lat),oErr:oR.err,fErr:fR.err,proxied}}

async function fetchOKX(asset){
  const fam=`${asset}-USD`;
  const[oR,sR,iR]=await Promise.all([cFetch(`https://www.okx.com/api/v5/market/tickers?instType=OPTION&instFamily=${fam}`),cFetch(`https://www.okx.com/api/v5/market/tickers?instType=SWAP&instFamily=${fam}`),cFetch(`https://www.okx.com/api/v5/market/index-tickers?instId=${asset}-USD`)]);
  const opts=[],perps=[];let spot=0;let proxied=oR.proxied||sR.proxied;
  if(iR.ok&&iR.data?.data?.[0])spot=parseFloat(iR.data.data[0].idxPx)||0;
  if(oR.ok&&oR.data?.data){for(const o of oR.data.data){const p=parseOI(o.instId);if(!p)continue;const S=spot;if(!S)continue;
    const bid=(parseFloat(o.bidPx)||0)*S,ask=(parseFloat(o.askPx)||0)*S;
    const mid=bid>0&&ask>0?(bid+ask)/2:0;const sprd=mid>0?((ask-bid)/mid)*100:null;
    opts.push({ex:'OKX',asset:p.asset,strike:p.strike,expiry:p.expiry,expiryDate:p.expiryDate,cp:p.cp,
      T:dTE(p.expiryDate)/365,bid,ask,mid,spot:S,markIv:null,sprd,vol24h:parseFloat(o.volCcy24h)||0,oi:parseFloat(o.oi)||0,raw:o.instId})}}
  if(sR.ok&&sR.data?.data){for(const f of sR.data.data){if(!f.instId.includes(asset))continue;const S=spot;const mk=parseFloat(f.last)||0;
    perps.push({ex:'OKX',asset,isPerpetual:true,instrument:f.instId,mark:mk,bid:parseFloat(f.bidPx)||0,ask:parseFloat(f.askPx)||0,
      vol24h:parseFloat(f.volCcy24h)||0,oi:parseFloat(f.oi)||0,spot:S,funding:f.fundingRate!=null?parseFloat(f.fundingRate):null,basis:S>0?(mk-S)/S*100:0})}}
  return{opts,perps,oOk:oR.ok,fOk:sR.ok,lat:Math.max(oR.lat,sR.lat||0,iR.lat||0),proxied}}

async function fetchBybit(asset){
  const[oR,lR]=await Promise.all([cFetch(`https://api.bybit.com/v5/market/tickers?category=option&baseCoin=${asset}`),cFetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${asset}USDT`)]);
  const opts=[],perps=[];let proxied=oR.proxied||lR.proxied;
  if(oR.ok&&oR.data?.result?.list){for(const o of oR.data.result.list){const p=parseDI(o.symbol);if(!p)continue;
    const S=parseFloat(o.underlyingPrice)||0;if(!S)continue;const bid=parseFloat(o.bid1Price)||0,ask=parseFloat(o.ask1Price)||0,mark=parseFloat(o.markPrice)||0;
    const mid=bid>0&&ask>0?(bid+ask)/2:mark;const sprd=mid>0&&bid>0&&ask>0?((ask-bid)/mid)*100:null;
    opts.push({ex:'Bybit',asset:p.asset,strike:p.strike,expiry:p.expiry,expiryDate:p.expiryDate,cp:p.cp,
      T:dTE(p.expiryDate)/365,bid,ask,mid,spot:S,markIv:o.markIv?parseFloat(o.markIv):null,sprd,vol24h:parseFloat(o.volume24h)||0,oi:parseFloat(o.openInterest)||0,raw:o.symbol})}}
  if(lR.ok&&lR.data?.result?.list){for(const f of lR.data.result.list){const mk=parseFloat(f.markPrice)||parseFloat(f.lastPrice)||0;const S=parseFloat(f.indexPrice)||mk;
    perps.push({ex:'Bybit',asset,isPerpetual:true,instrument:f.symbol,mark:mk,bid:parseFloat(f.bid1Price)||0,ask:parseFloat(f.ask1Price)||0,
      vol24h:parseFloat(f.volume24h)||0,oi:parseFloat(f.openInterest)||0,spot:S,funding:f.fundingRate!=null?parseFloat(f.fundingRate):null,basis:S>0?(mk-S)/S*100:0})}}
  return{opts,perps,oOk:oR.ok,fOk:lR.ok,lat:Math.max(oR.lat,lR.lat),proxied}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FEES={PT:{m:.0003,t:.0005},Deribit:{m:.0002,t:.0003},OKX:{m:.0002,t:.0003},Bybit:{m:.0002,t:.0004}};
const G={tab:'health',loading:true,tick:0,live:true,openA:null,useProxy:true,
  fAsset:'ALL',fCat:'ALL',fSev:'ALL',fProf:false,
  hAsset:'ALL',hExpiry:'ALL',hFilter:'ALL',compAsset:'BTC',compExpiry:null,
  th:{ptSprd:15,ptVsMkt:20,ivArb:8,perpBps:5,fundBps:6,lowVolPct:10},
  refreshMs:25000,
  conn:{PT:{ok:false},Deribit:{ok:false},OKX:{ok:false},Bybit:{ok:false}},
  ptOpts:[],ptPerps:[],ptItems:[],mktOpts:[],mktPerps:[],alerts:[],spots:{},lastUp:null,errors:[]};
let timer=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ORDERBOOK HEALTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function analyzeHealth(ptOpts){
  const items=ptOpts.map(o=>{
    const hasBid=o.bid!=null&&o.bid>0,hasAsk=o.ask!=null&&o.ask>0;
    let status='EMPTY';
    if(hasBid&&hasAsk)status=o.sprd!=null&&o.sprd>=G.th.ptSprd?'WIDE':'QUOTED';
    else if(hasBid||hasAsk)status='ONE_SIDED';
    return{...o,hasBid,hasAsk,status};
  });
  const byG={};
  for(const o of items){const g=`${o.asset}-${o.expiry}`;if(!byG[g])byG[g]=[];byG[g].push(o)}
  for(const arr of Object.values(byG)){
    const vols=arr.map(a=>a.vol24h).filter(v=>v>0);
    const avgV=vols.length?vols.reduce((a,b)=>a+b,0)/vols.length:0;
    const maxV=vols.length?Math.max(...vols):0;
    for(const o of arr){o.groupAvgVol=avgV;o.groupMaxVol=maxV;
      o.volPctOfMax=maxV>0?o.vol24h/maxV*100:0;
      o.isLowVol=avgV>0&&o.vol24h>0&&o.vol24h<avgV*(G.th.lowVolPct/100);
      o.isZeroVol=o.vol24h===0;
    }
  }
  return items;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERT DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detect(ptItems,ptPerps,mktOpts,mktPerps,th){
  const al=[];
  for(const o of ptItems){
    if(o.status==='ONE_SIDED')al.push({cat:'PT_STALE',sev:'warning',asset:o.asset,title:o.raw,val:0,
      msg:`One-sided: ${o.hasBid?'Bid $'+o.bid.toFixed(2)+' only':'Ask $'+o.ask.toFixed(2)+' only'}`,
      detail:`OI: ${o.oi} | Vol: $${o.vol24h} | Spot: $${o.spot?.toFixed(0)||'?'}`,net:0,profitable:false,act:'‚ö† Check MM quoting'});
    if(o.status==='WIDE')al.push({cat:'PT_WIDE',sev:o.sprd>=th.ptSprd*2?'critical':'warning',asset:o.asset,title:o.raw,
      val:o.sprd,msg:`Spread ${o.sprd.toFixed(1)}% ‚Äî Bid $${o.bid.toFixed(2)} / Ask $${o.ask.toFixed(2)}`,
      detail:`Mid: $${o.mid.toFixed(2)} | OI: ${o.oi}`,net:0,profitable:false,act:'‚ö† Wide ‚Äî flag to MM'});
  }
  const mktByK={};for(const o of mktOpts){if(o.T<.001||o.mid<=0)continue;const k=`${o.asset}-${o.strike}-${o.expiry}-${o.cp}`;if(!mktByK[k])mktByK[k]=[];mktByK[k].push(o)}
  for(const pt of ptItems){
    if(pt.mid<=0||pt.T<.001)continue;const k=`${pt.asset}-${pt.strike}-${pt.expiry}-${pt.cp}`;
    const mkts=mktByK[k];if(!mkts)continue;const mids=mkts.filter(m=>m.mid>0).map(m=>m.mid);
    if(!mids.length)continue;const mktMid=mids.reduce((a,b)=>a+b,0)/mids.length;
    const diff=((pt.mid-mktMid)/mktMid)*100;const ad=Math.abs(diff);
    if(ad>=th.ptVsMkt){const cheap=diff<0;
      const best=cheap?mkts.reduce((a,b)=>(b.bid||0)>(a.bid||0)?b:a,mkts[0]):mkts.reduce((a,b)=>((b.ask||0)<(a.ask||0)&&b.ask>0)?b:a,mkts[0]);
      const actionable=cheap?(pt.ask!=null&&pt.ask<(best.bid||0)):(pt.bid!=null&&pt.bid>(best.ask||Infinity));
      const gross=actionable?(cheap?(best.bid||0)-pt.ask:pt.bid-(best.ask||0)):0;
      const S=pt.spot||mktMid;const fees=(FEES.PT.t+(FEES[best.ex]?.t||.0005))*S;const net=gross-fees;
      al.push({cat:cheap?'PT_CHEAP':'PT_RICH',sev:ad>=th.ptVsMkt*2?'critical':'warning',asset:pt.asset,title:pt.raw,val:ad,
        msg:`PT mid $${pt.mid.toFixed(2)} vs Mkt $${mktMid.toFixed(2)} (${diff>0?'+':''}${diff.toFixed(1)}%)`,
        detail:`PT: $${pt.bid?.toFixed(2)||'‚Äî'}/$${pt.ask?.toFixed(2)||'‚Äî'} | ${best.ex}: $${best.bid?.toFixed(2)||'‚Äî'}/$${best.ask?.toFixed(2)||'‚Äî'}${actionable?` | Net: $${net.toFixed(2)}`:''}`,
        net:actionable?net:0,profitable:actionable&&net>0,
        act:cheap?(actionable?`BUY PT@$${pt.ask?.toFixed(2)} ‚Üí SELL ${best.ex}@$${(best.bid||0).toFixed(2)}`:'PT cheap but not arb-able')
          :(actionable?`SELL PT@$${pt.bid?.toFixed(2)} ‚Üí BUY ${best.ex}@$${(best.ask||0).toFixed(2)}`:'PT rich but not arb-able')})
    }
  }
  const pBA={};for(const p of[...ptPerps,...mktPerps]){if(!p.isPerpetual)continue;if(!pBA[p.asset])pBA[p.asset]={};pBA[p.asset][p.ex]=p}
  for(const[asset,em] of Object.entries(pBA)){const pt=em.PT;if(!pt)continue;
    for(const[ex,mp] of Object.entries(em)){if(ex==='PT')continue;
      const bd=Math.abs(pt.basis-mp.basis)*100;
      if(bd>=th.perpBps)al.push({cat:'PERP_ARB',sev:bd>th.perpBps*2?'critical':'warning',asset,title:`${asset} PERP PT‚Üî${ex}`,
        val:bd,msg:`Basis Œî ${bd.toFixed(1)}bps`,detail:`PT: $${pt.mark.toFixed(2)} | ${ex}: $${mp.mark.toFixed(2)}`,
        net:Math.abs(pt.mark-mp.mark),profitable:bd>3,act:pt.mark<mp.mark?`LONG PT / SHORT ${ex}`:`SHORT PT / LONG ${ex}`});
    }}
  return al.sort((a,b)=>(a.sev==='critical'?0:1)-(b.sev==='critical'?0:1)||b.val-a.val);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REFRESH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function refresh(){
  G.loading=true;render();const errs=[];
  G.conn={PT:{ok:false,n:0,lat:0},Deribit:{ok:false,n:0,lat:0},OKX:{ok:false,n:0,lat:0},Bybit:{ok:false,n:0,lat:0}};
  const[ptR,...mktRs]=await Promise.allSettled([fetchPT(),fetchDeribit('BTC'),fetchDeribit('ETH'),fetchOKX('BTC'),fetchOKX('ETH'),fetchBybit('BTC'),fetchBybit('ETH')]);
  if(ptR.status==='fulfilled'&&ptR.value){const d=ptR.value;
    if(d.ok){G.ptOpts=d.opts;G.ptPerps=d.perps;G.conn.PT={ok:true,n:d.count,lat:d.lat,proxied:d.proxied};Object.assign(G.spots,d.spots)}
    else{errs.push(`PT: ${d.err}`);G.ptOpts=[];G.ptPerps=[];G.conn.PT={ok:false,err:d.err}}}
  else{errs.push(`PT: ${ptR.reason||'failed'}`);G.ptOpts=[];G.ptPerps=[]}
  let mo=[],mp=[];const mL=['Deribit BTC','Deribit ETH','OKX BTC','OKX ETH','Bybit BTC','Bybit ETH'],mE=['Deribit','Deribit','OKX','OKX','Bybit','Bybit'];
  mktRs.forEach((r,i)=>{const ex=mE[i];
    if(r.status==='fulfilled'&&r.value){const d=r.value;
      if(d.oOk){mo=mo.concat(d.opts);G.conn[ex].ok=true;G.conn[ex].n=(G.conn[ex].n||0)+d.opts.length;G.conn[ex].lat=Math.max(G.conn[ex].lat||0,d.lat);if(d.proxied)G.conn[ex].proxied=true}
      if(d.fOk){mp=mp.concat(d.perps);G.conn[ex].ok=true;G.conn[ex].n=(G.conn[ex].n||0)+d.perps.length}
      for(const p of d.perps||[])if(p.spot>0)G.spots[p.asset]=p.spot;
      for(const o of d.opts||[])if(o.spot>0&&!G.spots[o.asset])G.spots[o.asset]=o.spot;
    }else errs.push(`${mL[i]}: ${r.reason||'failed'}`)});
  G.mktOpts=mo;G.mktPerps=mp;
  G.ptItems=analyzeHealth(G.ptOpts);
  G.alerts=detect(G.ptItems,G.ptPerps,mo,mp,G.th);
  G.errors=errs;G.loading=false;G.lastUp=new Date();G.tick++;
  if(!G.compExpiry){const es=[...new Set(G.ptOpts.filter(o=>o.asset===G.compAsset).map(o=>o.expiry))];if(es.length)G.compExpiry=es[0]}
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $n=v=>typeof v==='number'?v.toLocaleString():v;
const $$=v=>typeof v==='number'?'$'+v.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}):'‚Äî';
const bg=(t,c)=>`<span class="badge bg-${c}">${t}</span>`;

// TAB: ORDERBOOK HEALTH
function rHealth(){
  const items=G.ptItems||[];if(!items.length)return`<div class="empty">No PT option data loaded ‚Äî check connections above</div>`;
  const{hAsset,hExpiry,hFilter}=G;
  const assets=[...new Set(items.map(o=>o.asset))].sort();
  const fa=items.filter(o=>(hAsset==='ALL'||o.asset===hAsset));
  const expiries=[...new Set(fa.map(o=>o.expiry))].sort((a,b)=>{const oa=fa.find(o=>o.expiry===a),ob=fa.find(o=>o.expiry===b);return(oa?.expiryDate?.getTime()||0)-(ob?.expiryDate?.getTime()||0)});
  const curExp=hExpiry!=='ALL'&&expiries.includes(hExpiry)?hExpiry:'ALL';
  let fi=fa.filter(o=>curExp==='ALL'||o.expiry===curExp);
  if(hFilter==='EMPTY')fi=fi.filter(o=>o.status==='EMPTY');
  else if(hFilter==='ONE_SIDED')fi=fi.filter(o=>o.status==='ONE_SIDED');
  else if(hFilter==='WIDE')fi=fi.filter(o=>o.status==='WIDE');
  else if(hFilter==='LOW_VOL')fi=fi.filter(o=>o.isLowVol||o.isZeroVol);
  else if(hFilter==='PROBLEMS')fi=fi.filter(o=>o.status!=='QUOTED');

  const total=fa.length,quoted=fa.filter(o=>o.status==='QUOTED').length,wide=fa.filter(o=>o.status==='WIDE').length;
  const oneSided=fa.filter(o=>o.status==='ONE_SIDED').length,empty=fa.filter(o=>o.status==='EMPTY').length;
  const zeroVol=fa.filter(o=>o.isZeroVol).length;
  const hp=total>0?Math.round(quoted/total*100):0;
  const hc=hp>=70?'var(--grn)':hp>=40?'var(--org)':'var(--red)';

  let h=`<div class="grid g2" style="margin-bottom:8px">
    <div class="card" style="display:flex;align-items:center;gap:16px">
      <div class="score-ring" style="color:${hc};border-color:${hc}">${hp}%</div>
      <div><div class="card-t" style="color:${hc};margin-bottom:2px">ORDERBOOK HEALTH${hAsset!=='ALL'?' ‚Äî '+hAsset:''}</div>
        <div class="mono dim" style="font-size:8px;line-height:1.5">${total} options listed ¬∑ ${quoted} properly quoted (two-sided, spread &lt;${G.th.ptSprd}%)<br>
        ${wide} wide ¬∑ ${oneSided} one-sided ¬∑ ${empty} empty ¬∑ ${zeroVol} zero volume</div></div></div>
    <div class="card"><div class="card-t" style="margin-bottom:4px">STATUS BREAKDOWN</div>
      <div class="grid g4" style="gap:4px">
        <div style="text-align:center"><div class="mono" style="font-size:16px;font-weight:800;color:var(--grn)">${quoted}</div><div class="mono dim" style="font-size:7px">QUOTED</div></div>
        <div style="text-align:center"><div class="mono" style="font-size:16px;font-weight:800;color:var(--org)">${wide}</div><div class="mono dim" style="font-size:7px">WIDE</div></div>
        <div style="text-align:center"><div class="mono" style="font-size:16px;font-weight:800;color:var(--red)">${oneSided}</div><div class="mono dim" style="font-size:7px">1-SIDED</div></div>
        <div style="text-align:center"><div class="mono" style="font-size:16px;font-weight:800;color:var(--dim)">${empty}</div><div class="mono dim" style="font-size:7px">EMPTY</div></div></div>
      <div class="bar-w" style="margin-top:6px"><div style="display:flex;height:8px">
        <div style="width:${quoted/total*100}%;background:var(--grn)"></div>
        <div style="width:${wide/total*100}%;background:var(--org)"></div>
        <div style="width:${oneSided/total*100}%;background:var(--red)"></div>
        <div style="width:${empty/total*100}%;background:var(--mut)"></div></div></div></div></div>`;

  // Health by expiry
  if(curExp==='ALL'&&expiries.length>1){
    h+=`<div class="card"><div class="card-t" style="margin-bottom:6px">HEALTH BY EXPIRY <span class="dim" style="font-weight:400;font-size:8px">click row to drill in</span></div>
    <div class="tbl-w"><table class="tbl"><thead><tr><th>Expiry</th><th>Days</th><th>Total</th><th>Quoted</th><th>Wide</th><th>1-Sided</th><th>Empty</th><th>0-Vol</th><th>Health</th><th></th></tr></thead><tbody>`;
    for(const exp of expiries){
      const eo=fa.filter(o=>o.expiry===exp);const q=eo.filter(o=>o.status==='QUOTED').length,w=eo.filter(o=>o.status==='WIDE').length;
      const os=eo.filter(o=>o.status==='ONE_SIDED').length,em=eo.filter(o=>o.status==='EMPTY').length;
      const zv=eo.filter(o=>o.isZeroVol).length;const ehp=eo.length>0?Math.round(q/eo.length*100):0;
      const ec=ehp>=70?'var(--grn)':ehp>=40?'var(--org)':'var(--red)';
      const days=eo[0]?Math.round(dTE(eo[0].expiryDate)):0;
      h+=`<tr style="cursor:pointer" onclick="G.hExpiry='${exp}';render()"><td style="font-weight:600;color:var(--acc)">${exp}</td><td>${days}d</td>
        <td>${eo.length}</td><td class="pos">${q}</td><td class="${w?'risk-md':'dim'}">${w||'‚Äî'}</td><td class="${os?'neg':'dim'}">${os||'‚Äî'}</td>
        <td class="dim">${em||'‚Äî'}</td><td class="dim">${zv||'‚Äî'}</td>
        <td style="font-weight:700;color:${ec}">${ehp}%</td>
        <td><div class="bar-w" style="width:80px;display:inline-block"><div style="display:flex;height:6px">
          <div style="width:${q/eo.length*100}%;background:var(--grn)"></div>
          <div style="width:${w/eo.length*100}%;background:var(--org)"></div>
          <div style="width:${os/eo.length*100}%;background:var(--red)"></div>
          <div style="width:${em/eo.length*100}%;background:var(--mut)"></div></div></div></td></tr>`}
    h+=`</tbody></table></div></div>`;
  }

  // Filters
  h+=`<div class="filters">
    ${['ALL',...assets].map(a=>`<button class="btn${hAsset===a?' btn-a':''}" onclick="G.hAsset='${a}';render()">${a}</button>`).join('')}
    <span style="width:4px"></span>
    ${curExp!=='ALL'?`<button class="btn btn-a" onclick="G.hExpiry='ALL';render()">‚Üê All Expiries</button>`:''}
    ${expiries.slice(0,10).map(e=>`<button class="btn${curExp===e?' btn-a':''}" style="font-size:8px" onclick="G.hExpiry='${e}';render()">${e}</button>`).join('')}
    <span style="width:8px"></span>
    ${[{id:'ALL',l:'All'},{id:'PROBLEMS',l:'‚ö† Problems'},{id:'EMPTY',l:'Empty'},{id:'ONE_SIDED',l:'1-Sided'},{id:'WIDE',l:'Wide'},{id:'LOW_VOL',l:'Low Vol'}].map(f=>`<button class="btn${hFilter===f.id?' btn-a':''}" onclick="G.hFilter='${f.id}';render()">${f.l}</button>`).join('')}
    <span class="mono dim" style="margin-left:auto;font-size:8px">${fi.length} shown</span></div>`;
  if(!fi.length)return h+`<div class="empty">No options match filter</div>`;

  fi.sort((a,b)=>{const so={EMPTY:0,ONE_SIDED:1,WIDE:2,QUOTED:3};return(so[a.status]||9)-(so[b.status]||9)||a.asset.localeCompare(b.asset)||a.expiryDate-b.expiryDate||a.strike-b.strike||(a.cp==='C'?0:1)-(b.cp==='C'?0:1)});
  h+=`<div class="tbl-w"><table class="tbl"><thead><tr><th>Status</th><th>Symbol</th><th>Asset</th><th>Expiry</th><th>Strike</th><th>C/P</th><th>Bid</th><th>Ask</th><th>Spread%</th><th>Last</th><th>Index</th><th>Vol24h</th><th>OI</th><th>Vol vs Peers</th></tr></thead><tbody>`;
  for(const o of fi.slice(0,300)){
    const sc={EMPTY:'red',ONE_SIDED:'org',WIDE:'org',QUOTED:'grn'}[o.status];
    const sl={EMPTY:'‚ùå EMPTY',ONE_SIDED:'‚ö† 1-SIDED',WIDE:'‚ö° WIDE',QUOTED:'‚úÖ OK'}[o.status];
    const vb=o.groupMaxVol>0?Math.min(o.vol24h/o.groupMaxVol*100,100):0;
    const vc=o.isZeroVol?'var(--mut)':o.isLowVol?'var(--red)':vb<30?'var(--org)':'var(--grn)';
    h+=`<tr><td>${bg(sl,sc)}</td>
      <td style="font-weight:600;color:var(--acc)">${o.raw}</td><td>${o.asset}</td><td>${o.expiry}</td>
      <td>$${$n(o.strike)}</td><td>${o.cp}</td>
      <td class="${!o.hasBid?'dim':''}">${o.hasBid?'$'+o.bid.toFixed(2):'<span class="neg">‚Äî</span>'}</td>
      <td class="${!o.hasAsk?'dim':''}">${o.hasAsk?'$'+o.ask.toFixed(2):'<span class="neg">‚Äî</span>'}</td>
      <td class="${o.sprd!=null&&o.sprd>=G.th.ptSprd?'risk-hi':o.sprd!=null&&o.sprd>=G.th.ptSprd*.5?'risk-md':'dim'}">${o.sprd!=null?o.sprd.toFixed(1)+'%':'‚Äî'}</td>
      <td class="dim">${o.last?'$'+o.last.toFixed(2):'‚Äî'}</td>
      <td class="dim">${o.spot?'$'+$n(o.spot.toFixed(0)):'‚Äî'}</td>
      <td class="${o.isZeroVol?'dim':o.isLowVol?'neg':''}">${o.vol24h>0?'$'+$n(Math.round(o.vol24h)):'‚Äî'}</td>
      <td class="dim">${o.oi>0?o.oi:'‚Äî'}</td>
      <td><div class="bar-w" style="width:60px;display:inline-block"><div class="bar" style="width:${vb}%;background:${vc}"></div></div>
        <span class="mono dim" style="font-size:7px;margin-left:2px">${o.isZeroVol?'ZERO':o.isLowVol?'LOW':vb>0?Math.round(vb)+'%':''}</span></td></tr>`;
  }
  h+=`</tbody></table></div>`;
  if(fi.length>300)h+=`<div class="mono dim" style="padding:4px;font-size:8px">Showing 300/${fi.length}</div>`;
  return h;
}

// TAB: ALERTS
function rAlerts(){
  const{alerts:al,fAsset,fCat,fSev,fProf,openA}=G;const cats=[...new Set(al.map(a=>a.cat))];
  const assets=[...new Set(al.map(a=>a.asset))].sort();
  const fa=al.filter(a=>(fAsset==='ALL'||a.asset===fAsset)&&(fCat==='ALL'||a.cat===fCat)&&(fSev==='ALL'||a.sev===fSev)&&(!fProf||a.profitable));
  const sel=(id,v,os)=>`<select class="flt" onchange="sF('${id}',this.value)">${os.map(o=>`<option${v===o?' selected':''}>${o}</option>`).join('')}</select>`;
  let h=`<div class="filters"><span class="mono dim" style="font-size:8px">FILTER:</span>${sel('fAsset',fAsset,['ALL',...assets])}${sel('fSev',fSev,['ALL','critical','warning'])}${sel('fCat',fCat,['ALL',...cats])}
    <label style="display:flex;align-items:center;gap:3px;font-family:var(--fm);font-size:9px;color:var(--dim);cursor:pointer"><input type="checkbox" ${fProf?'checked':''} onchange="G.fProf=this.checked;render()"> Actionable only</label>
    <span class="mono dim" style="margin-left:auto;font-size:8px">${fa.length}/${al.length}</span></div>`;
  if(!fa.length)return h+`<div class="empty">${al.length?'No alerts match filters':'‚úÖ No alerts at current thresholds'}</div>`;
  const catCol={PT_WIDE:'org',PT_STALE:'red',PT_CHEAP:'grn',PT_RICH:'prp',PERP_ARB:'grn',FUND_ARB:'blu'};
  const catLbl={PT_WIDE:'PT WIDE',PT_STALE:'PT STALE',PT_CHEAP:'PT CHEAP',PT_RICH:'PT RICH',PERP_ARB:'PERP ARB',FUND_ARB:'FUNDING'};
  return h+fa.slice(0,150).map(a=>{const id=(a.title+a.cat).replace(/[^a-zA-Z0-9]/g,'_');
    return`<div class="alert-row${a.sev==='critical'?' crit':''}${openA===id?' open':''}" onclick="togA('${id}')"><div class="alert-hd">
      ${bg(a.sev==='critical'?'CRIT':'WARN',a.sev==='critical'?'red':'org')} ${bg(catLbl[a.cat]||a.cat,catCol[a.cat]||'acc')} ${bg(a.asset,'acc')}
      ${a.profitable?bg('ACTIONABLE','grn'):''}<span class="alert-t">${a.title}</span></div>
      <div class="alert-d">${a.msg}<br>${a.detail}<br>
      ${a.profitable?`<span class="pos" style="font-weight:700">Net: $${a.net.toFixed(2)}</span><br>`:''}<span style="display:inline-block;margin-top:3px;padding:2px 8px;border-radius:2px;font-weight:700;background:${a.profitable?'var(--grnBg)':'rgba(230,168,23,.08)'};color:${a.profitable?'var(--grn)':'var(--acc)'}">‚Üí ${a.act}</span></div></div>`}).join('')}

// TAB: PT vs MARKET
function rComp(){
  const{ptOpts,mktOpts,compAsset:ca,compExpiry:ce}=G;const assets=[...new Set(ptOpts.map(o=>o.asset))].sort();
  const ao=ptOpts.filter(o=>o.asset===ca);
  const expiries=[...new Set(ao.map(o=>o.expiry))].sort((a,b)=>{const oa=ao.find(o=>o.expiry===a),ob=ao.find(o=>o.expiry===b);return(oa?.expiryDate?.getTime()||0)-(ob?.expiryDate?.getTime()||0)});
  const cur=ce&&expiries.includes(ce)?ce:expiries[0];const ptExp=ao.filter(o=>o.expiry===cur);
  const strikes=[...new Set(ptExp.map(o=>o.strike))].sort((a,b)=>a-b);const Sp=G.spots[ca]||0;
  const mktExs=[...new Set(mktOpts.filter(o=>o.asset===ca&&o.expiry===cur).map(o=>o.ex))].sort();
  let h=`<div class="filters">${assets.map(a=>`<button class="btn${ca===a?' btn-a':''}" onclick="G.compAsset='${a}';G.compExpiry=null;render()">${a}</button>`).join('')}
    <span style="width:8px"></span>${expiries.slice(0,12).map(e=>`<button class="btn${cur===e?' btn-a':''}" style="font-size:8px" onclick="G.compExpiry='${e}';render()">${e}</button>`).join('')}
    <span class="mono dim" style="margin-left:auto;font-size:8px">Index: ${Sp?'$'+$n(Sp.toFixed(0)):'?'}</span></div>`;
  if(!strikes.length)return h+`<div class="empty">No PT options for ${ca} ${cur||''}</div>`;
  h+=`<div class="info-box">üí° <b>PT is reference.</b> Diff = (PT mid ‚àí Mkt avg) / Mkt avg. <span class="pos">Green = PT cheaper.</span> <span class="neg">Red = PT richer.</span>${!mktExs.length?' <b>No matching market expiry found.</b>':''}</div>`;
  if(!mktExs.length)return h;
  h+=`<div class="tbl-w"><table class="tbl"><thead><tr><th>Strike</th><th>C/P</th><th style="color:var(--acc)">PT Bid</th><th style="color:var(--acc)">PT Ask</th><th style="color:var(--acc)">PT Sprd%</th>`;
  mktExs.forEach(e=>{h+=`<th>${e} Bid</th><th>${e} Ask</th>`});
  h+=`<th style="color:var(--cyn)">Diff%</th><th>Signal</th></tr></thead><tbody>`;
  for(const K of strikes){for(const cp of['C','P']){
    const pt=ptExp.find(o=>o.strike===K&&o.cp===cp);if(!pt)continue;const atm=Sp>0&&Math.abs(K-Sp)/Sp<.015;
    const mktD=mktExs.map(ex=>mktOpts.find(m=>m.asset===ca&&m.strike===K&&m.expiry===cur&&m.cp===cp&&m.ex===ex));
    const mktMids=mktD.filter(m=>m&&m.mid>0).map(m=>m.mid);const mktAvg=mktMids.length?mktMids.reduce((a,b)=>a+b,0)/mktMids.length:0;
    const diff=mktAvg>0&&pt.mid>0?((pt.mid-mktAvg)/mktAvg*100):null;const ad=diff!=null?Math.abs(diff):0;
    const dc=diff==null?'dim':ad<G.th.ptVsMkt?'dim':diff<0?'pos':'neg';
    h+=`<tr${atm?' style="background:rgba(230,168,23,.04)"':''}>
      <td style="font-weight:600${atm?';color:var(--acc)':''}">$${$n(K)}</td><td>${cp}</td>
      <td class="${pt.bid==null?'dim':''}">${pt.bid!=null?pt.bid.toFixed(2):'<span class="neg">‚Äî</span>'}</td>
      <td class="${pt.ask==null?'dim':''}">${pt.ask!=null?pt.ask.toFixed(2):'<span class="neg">‚Äî</span>'}</td>
      <td class="${pt.sprd!=null&&pt.sprd>=G.th.ptSprd?'risk-hi':'dim'}">${pt.sprd!=null?pt.sprd.toFixed(1):'‚Äî'}</td>`;
    mktExs.forEach((ex,i)=>{const m=mktD[i];h+=`<td class="dim">${m&&m.bid>0?m.bid.toFixed(2):'‚Äî'}</td><td class="dim">${m&&m.ask>0?m.ask.toFixed(2):'‚Äî'}</td>`});
    h+=`<td class="${dc}" style="font-weight:700">${diff!=null?(diff>0?'+':'')+diff.toFixed(1)+'%':'‚Äî'}</td>
      <td style="font-size:8px">${diff==null?'':ad<G.th.ptVsMkt?'‚úÖ':diff<0?'üü¢ CHEAP':'üî¥ RICH'}</td></tr>`}}
  h+=`</tbody></table></div>`;return h}

// TAB: PERPS
function rPerps(){
  const allP=[...G.ptPerps,...G.mktPerps.filter(p=>p.isPerpetual)];const assets=[...new Set(allP.map(p=>p.asset))].sort();
  let h='';assets.forEach(asset=>{const rows=allP.filter(p=>p.asset===asset&&p.isPerpetual);if(!rows.length)return;
    h+=`<div class="card"><div class="card-h"><span class="card-t" style="color:var(--acc)">${asset} PERPETUAL</span><span class="mono dim" style="font-size:8px">Index: ${G.spots[asset]?'$'+$n(G.spots[asset].toFixed(2)):'?'}</span></div>
    <div class="tbl-w"><table class="tbl"><thead><tr><th>Exchange</th><th>Mark</th><th>Bid</th><th>Ask</th><th>Spread</th><th>Basis</th><th>Funding</th><th>Vol 24h</th><th>OI</th></tr></thead><tbody>
    ${rows.map(p=>{const sp=p.bid!=null&&p.ask!=null&&p.bid>0&&p.ask>0?((p.ask-p.bid)/((p.bid+p.ask)/2)*10000).toFixed(1):'‚Äî';const isPT=p.ex==='PT';
      return`<tr${isPT?' style="background:rgba(230,168,23,.05);border-left:3px solid var(--acc)"':''}>
        <td style="font-weight:600${isPT?';color:var(--acc)':''}">${p.ex}${isPT?' ‚òÖ':''}</td>
        <td>${$$(p.mark)}</td><td class="pos">${p.bid!=null?$$(p.bid):'‚Äî'}</td><td class="neg">${p.ask!=null?$$(p.ask):'‚Äî'}</td>
        <td>${sp}${sp!=='‚Äî'?'bps':''}</td><td class="${Math.abs(p.basis)>.05?'risk-md':'dim'}">${p.basis.toFixed(4)}%</td>
        <td class="${p.funding!=null?(p.funding>0?'pos':'neg'):'dim'}">${p.funding!=null?(p.funding*100).toFixed(4)+'%':'‚Äî'}</td>
        <td class="dim">${$n(Math.round(p.vol24h))}</td><td class="dim">${$n(Math.round(p.oi))}</td></tr>`}).join('')}
    </tbody></table></div></div>`});
  return h||`<div class="empty">No perp data</div>`}

// TAB: CONFIG
function rConf(){const{th,refreshMs}=G;
  const inp=(l,k,u,s=1)=>`<div class="th-row"><span class="th-l">${l}</span><input class="th-i" type="number" value="${th[k]}" step="${s}" min="0" onchange="sTh('${k}',+this.value)"/><span class="th-u">${u}</span></div>`;
  const proxiedHosts=Object.keys(needsProxy).filter(h=>needsProxy[h]);
  return`${G.useProxy&&proxiedHosts.length?`<div class="prp-box">üîÄ <b>CORS proxy active</b> for: ${proxiedHosts.join(', ')} ‚Äî routed via corsproxy.io. Data is still live from the exchanges.</div>`:''}
  <div class="grid g3">
    <div class="card"><div class="card-t" style="color:var(--acc);margin-bottom:8px">üîî PT INTERNAL</div>
      ${inp('PT Wide Spread','ptSprd','%')}${inp('PT vs Market Diff','ptVsMkt','%')}${inp('Low Vol (% of avg)','lowVolPct','%',5)}</div>
    <div class="card"><div class="card-t" style="color:var(--prp);margin-bottom:8px">üìä CROSS-EXCHANGE</div>
      ${inp('IV Arb','ivArb','%')}${inp('Perp Basis Diff','perpBps','bps')}${inp('Funding Diff','fundBps','bps')}</div>
    <div class="card"><div class="card-t" style="color:var(--cyn);margin-bottom:8px">‚ö° PRESETS</div>
      <button class="preset" onclick="pre({ptSprd:5,ptVsMkt:8,ivArb:3,perpBps:2,fundBps:3,lowVolPct:10})">üî¨ <b>Tight</b> ‚Äî BTC/ETH liquid</button>
      <button class="preset" onclick="pre({ptSprd:15,ptVsMkt:20,ivArb:8,perpBps:5,fundBps:6,lowVolPct:10})">‚öñÔ∏è <b>Normal</b> ‚Äî illiquid (default)</button>
      <button class="preset" onclick="pre({ptSprd:30,ptVsMkt:40,ivArb:15,perpBps:10,fundBps:12,lowVolPct:5})">üéØ <b>Ultra-Wide</b> ‚Äî extreme only</button></div>
    <div class="card"><div class="card-t" style="color:var(--org);margin-bottom:8px">üîå CONNECTION</div>
      <div class="th-row"><span class="th-l">Auto-Refresh</span><input class="th-i" type="number" value="${refreshMs/1000}" step="5" min="10" onchange="sR(+this.value*1000)"/><span class="th-u">sec</span></div>
      <div class="th-row" style="margin-top:4px"><span class="th-l">CORS Proxy Fallback</span>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" ${G.useProxy?'checked':''} onchange="G.useProxy=this.checked;Object.keys(needsProxy).forEach(k=>delete needsProxy[k]);refresh()"><span class="mono" style="font-size:9px;color:${G.useProxy?'var(--grn)':'var(--dim)'}">${G.useProxy?'ON':'OFF'}</span></label></div>
      <div style="margin-top:6px;font-family:var(--fm);font-size:8px;color:var(--dim);line-height:1.6">
        <b>How it works:</b> Tries direct fetch first.<br>If CORS blocked ‚Üí retries via corsproxy.io<br>
        Exchanges remember which need proxy.<br><br>
        <b>APIs (all public):</b><br>
        <span style="color:var(--acc);font-weight:700">‚òÖ PT:</span> api.rest.prod.power.trade<br>
        Deribit ¬∑ OKX ¬∑ Bybit</div></div>
    <div class="card"><div class="card-t" style="color:var(--org);margin-bottom:8px">üíµ FEES</div>
      <div class="tbl-w"><table class="tbl"><thead><tr><th>Exchange</th><th>Maker</th><th>Taker</th></tr></thead><tbody>
      ${Object.entries(FEES).map(([e,f])=>`<tr><td style="${e==='PT'?'color:var(--acc);font-weight:700':''}">${e}</td><td>${(f.m*100).toFixed(2)}%</td><td>${(f.t*100).toFixed(2)}%</td></tr>`).join('')}</tbody></table></div></div>
  </div>
  ${G.errors.length?`<div class="card" style="margin-top:8px"><div class="card-t neg" style="margin-bottom:4px">‚ö† ERRORS</div><div class="mono dim" style="font-size:8px;line-height:1.5">${G.errors.map(e=>`‚Ä¢ ${e}`).join('<br>')}</div></div>`:''}`}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render(){
  const{tab,tick,live,loading,conn,spots,alerts,ptOpts,ptPerps,ptItems,mktOpts,lastUp}=G;
  const items=ptItems||[];
  const nc=alerts.filter(a=>a.sev==='critical').length,nw=alerts.filter(a=>a.sev==='warning').length,nAct=alerts.filter(a=>a.profitable).length;
  const quoted=items.filter(o=>o.status==='QUOTED').length,problems=items.filter(o=>o.status!=='QUOTED').length,emptyN=items.filter(o=>o.status==='EMPTY').length;
  const fa=alerts.filter(a=>(G.fAsset==='ALL'||a.asset===G.fAsset)&&(G.fCat==='ALL'||a.cat===G.fCat)&&(G.fSev==='ALL'||a.sev===G.fSev)&&(!G.fProf||a.profitable));
  const hp=items.length>0?Math.round(quoted/items.length*100):0;
  const hc=hp>=70?'var(--grn)':hp>=40?'var(--org)':'var(--red)';
  const tabs=[{id:'health',l:'üè• ORDERBOOK HEALTH'},{id:'alerts',l:'üö® ALERTS',n:fa.length},{id:'compare',l:'‚öñÔ∏è PT vs MARKET'},{id:'perps',l:'üìä PERPS'},{id:'config',l:'üéö CONFIG'}];
  const ch=Object.entries(conn).map(([ex,c])=>{const isPT=ex==='PT';const px=c.proxied;
    return`<div class="conn ${c.ok?px?'proxy':'ok':(loading?'load':'err')}"><div class="dot" style="background:${c.ok?px?'var(--prp)':'var(--grn)':(loading?'var(--acc)':'var(--red)')};${c.ok?'box-shadow:0 0 4px '+(px?'var(--prp)':'var(--grn)'):''}"></div>
    <span style="color:${isPT&&c.ok?'var(--acc)':(c.ok?(px?'var(--prp)':'var(--grn)'):(loading?'var(--acc)':'var(--red)'))};font-weight:${isPT?'800':'600'}">${ex}${isPT?' ‚òÖ':''}</span>
    ${c.ok?`<span class="dim">${c.n||0}${px?' via proxy':''} ¬∑ ${c.lat||0}ms</span>`:(loading?'<span class="spinner"></span>':`<span class="dim">${c.err?'CORS?':'fail'}</span>`)}</div>`}).join('');
  const sh=Object.entries(spots).map(([a,p])=>`<span class="spot-item">${a} <b style="color:var(--acc)">$${$n(p.toFixed(a==='BTC'?1:2))}</b></span>`).join('');

  document.getElementById('app').innerHTML=`
  <div class="hdr"><div class="logo"><div class="logo-i">üö®</div><div><div class="logo-t">POWERTRADE POLICE</div><div class="logo-s">PT-CENTRIC ¬∑ GITHUB PAGES ¬∑ LIVE v3</div></div></div>
    <div class="hdr-r">${loading?'<span class="spinner"></span>':''}
    <div class="dot" style="background:${live?'var(--grn)':'var(--dim)'}${live?';box-shadow:0 0 6px var(--grn);animation:pulse 2s infinite':''}"></div>
    <button class="btn" onclick="tL()">${live?`LIVE ${G.refreshMs/1000}s`:'PAUSED'}</button>
    <button class="btn btn-a" onclick="refresh()">‚Üª</button>
    <span class="mono dim" style="font-size:8px">#${tick} ${lastUp?lastUp.toLocaleTimeString():''}</span></div></div>
  <div class="conn-bar">${ch}<span style="margin-left:auto" class="dim">${ptOpts.length} PT opts ¬∑ ${mktOpts.length} mkt opts</span></div>
  ${sh?`<div class="spot-bar">${sh}</div>`:''}
  <div class="kpi-bar">
    <div class="kpi"><div class="kpi-l">PT Health</div><div class="kpi-v" style="color:${hc}">${hp}%</div><div class="kpi-s">${quoted}/${items.length}</div></div>
    <div class="kpi"><div class="kpi-l">Problems</div><div class="kpi-v" style="color:var(--red)">${problems}</div><div class="kpi-s">wide/empty/1-side</div></div>
    <div class="kpi"><div class="kpi-l">Empty</div><div class="kpi-v" style="color:var(--dim)">${emptyN}</div><div class="kpi-s">no quotes</div></div>
    <div class="kpi"><div class="kpi-l">Alerts</div><div class="kpi-v" style="color:var(--org)">${nc+nw}</div><div class="kpi-s">${nc}c / ${nw}w</div></div>
    <div class="kpi"><div class="kpi-l">Actionable</div><div class="kpi-v" style="color:var(--grn)">${nAct}</div></div>
  </div>
  <div class="tabs">${tabs.map(t=>`<button class="tab${tab===t.id?' on':''}" onclick="sTab('${t.id}')">${t.l}${t.n!=null?`<span class="cnt">${t.n}</span>`:''}</button>`).join('')}</div>
  <div class="main">${tab==='health'?rHealth():tab==='alerts'?rAlerts():tab==='compare'?rComp():tab==='perps'?rPerps():tab==='config'?rConf():''}</div>
  <div class="footer"><span>VIVI Risk Team ¬∑ PowerTrade Police v3 ¬∑ GitHub Pages Ready</span>
    <span>${Object.keys(needsProxy).length?' CORS proxy active ¬∑':''} ${lastUp?lastUp.toISOString():''}</span></div>`}

function sTab(t){G.tab=t;render()}
function sF(k,v){G[k]=v;render()}
function sTh(k,v){G.th[k]=v;G.ptItems=analyzeHealth(G.ptOpts);G.alerts=detect(G.ptItems,G.ptPerps,G.mktOpts,G.mktPerps,G.th);render()}
function pre(p){G.th=p;G.ptItems=analyzeHealth(G.ptOpts);G.alerts=detect(G.ptItems,G.ptPerps,G.mktOpts,G.mktPerps,G.th);render()}
function togA(id){G.openA=G.openA===id?null:id;render()}
function tL(){G.live=!G.live;if(timer)clearInterval(timer);if(G.live)timer=setInterval(refresh,G.refreshMs);render()}
function sR(ms){G.refreshMs=Math.max(10000,ms);if(timer)clearInterval(timer);if(G.live)timer=setInterval(refresh,G.refreshMs);render()}

(async()=>{await refresh();if(G.live)timer=setInterval(refresh,G.refreshMs)})();
</script>
</body>
</html>
